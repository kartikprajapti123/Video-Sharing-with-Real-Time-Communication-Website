<!DOCTYPE html>
<html lang="en">

<head>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
	<title>Dreams LMS</title>

	<!-- Favicon -->
	<link rel="shortcut icon" type="image/x-icon" href="/static/img/favicon.svg">

	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="/static/css/bootstrap.min.css">

	<!-- Fontawesome CSS -->
	<link rel="stylesheet" href="/static/plugins/fontawesome/css/fontawesome.min.css">
	<link rel="stylesheet" href="/static/plugins/fontawesome/css/all.min.css">

	<!-- Feather CSS -->
	<link rel="stylesheet" href="/static/css/feather.css">

	<!-- Boxioons CSS -->
	<link rel="stylesheet" href="/static/plugins/boxicons/css/boxicons.min.css">

	<!-- Swiper CSS -->
	<link rel="stylesheet" href="/static/plugins/swiper/swiper.min.css">

	<!-- Main CSS -->
	<link rel="stylesheet" href="/static/css/style.css">
	<link rel="stylesheet" href="/static/css/message_box.css">
	<style>
		.chat-bubble {
			background-color: #FDF4F3;
			padding: 16px 28px;
			-webkit-border-radius: 20px;
			-webkit-border-bottom-left-radius: 2px;
			-moz-border-radius: 20px;
			-moz-border-radius-bottomleft: 2px;
			border-radius: 20px;
			border-bottom-left-radius: 2px;
			display: inline-block;
		}

		.typing {
			align-items: center;
			display: flex;
			height: 17px;
		}

		.typing .dot {
			animation: mercuryTypingAnimation 1.8s infinite ease-in-out;
			background-color: #FF4667;;
			border-radius: 50%;
			height: 7px;
			margin-right: 4px;
			vertical-align: middle;
			width: 7px;
			display: inline-block;
		}

		.typing .dot:nth-child(1) {
			animation-delay: 200ms;
		}

		.typing .dot:nth-child(2) {
			animation-delay: 300ms;
		}

		.typing .dot:nth-child(3) {
			animation-delay: 400ms;
		}

		.typing .dot:last-child {
			margin-right: 0;
		}

		@keyframes mercuryTypingAnimation {
			0% {
				transform: translateY(0px);
				background-color: #FDF4F3;
			}

			28% {
				transform: translateY(-7px);
				background-color: #FDF4F3;
			}

			44% {
				transform: translateY(0px);
				background-color: #FDF4F3;
			}
		}
	</style>

</head>

<body class="chat-page main-chat-blk">
	<div class="wrapper-success" id="message-box" style="position: fixed;z-index:1000000;width:50%;">
		<div id="card" style="transition-duration: 2s;width:100%">
			<div class="icon" id="message-icon-parent"><i class="fas fa-times-circle " id="message-icon-child"></i>
			</div>
			<div class="subject">
				<h3 id="message-type">Success</h3>
				<p id="message-content">Anyone with access can view your invited visitors</p>
			</div>
			<div class="icon-times" id="message_close"><i class="fas fa-times"></i></div>
		</div>
	</div>
	<!-- Main Wrapper -->
	<div class="main-wrapper chat-wrapper">

		<!-- Header -->

		<!-- /Header -->

		<!-- Breadcrumb -->

		<!-- /Breadcrumb -->

		<!-- Page Content -->
		<div class="page-content chat-page-wrapper" style="padding:0px;">
			<div class="container">
				<div class="row" style="display: flex;
    justify-content: center;">

					<!-- sidebar -->

					<!-- Student Profile -->
					<div class="col-xl-9 col-lg-9 theiaStickySidebar">

						<div class="settings-widget card-details mb-0">
							<a href="/contact-list/">

								<div class="add-course btn-primary" id="Send_Message" style="    width: fit-content;
    margin: 13px;">Back</div>
							</a>
							<div class="settings-menu p-0">
								<div class="profile-heading">
									<h3>Message</h3>
								</div>

								<div class="checkout-form">
									<!-- sidebar group -->
									<div class="content">
										<div class="chat chat-messages" id="middle">
											<div class="h-100">
												<div class="chat-header">
													<div class="user-details mb-0">

														<figure class="avatar mb-0">
															<img src="/static/img/user/user12.jpg"
																class="rounded-circle" alt="image"
																id="other_user_image">
														</figure>
														<div class="mt-1">
															<h5 id="other_user_username"></h5>

														</div>
													</div>
													<div class="chat-options ">

													</div>

												</div>
												<div class="chat-body chat-page-group slimscroll" >
													<div class="messages" id="allChats" style="overflow-x:hidden !important;overflow-y:hidden !important; ">
														

													</div>

												</div>
											</div>
											<div class="chat-footer">
												<form>

													<div class="replay-forms">

														<input id='chat_input' type="text"
															class="form-control chat_form"
															placeholder="Type your message here...">
													</div>
													<div class="form-buttons">
														<button class="btn send-btn" type="submit" id="chat_button">
															<i class="bx bx-paper-plane"></i>
														</button>
													</div>
												</form>
											</div>
										</div>
										<!-- /Chat -->
									</div>
								</div>
							</div>
						</div>
					</div>
					<!-- Student Profile -->

				</div>
			</div>
		</div>
		<!-- /Page Content -->

		<!-- Footer -->

	</div>
	<!-- /Main Wrapper -->

	<!-- jQuery -->
	<script>
		function scrolling() {
			let chatMessages = document.getElementById("allChats");
			if (chatMessages) {
				// Focus on the chatMessages element
				chatMessages.focus();
				
				let lastMessage = chatMessages.lastElementChild;
				if (lastMessage) {
					// Scroll the last message into view smoothly
					lastMessage.scrollIntoView({ behavior: 'smooth' });
				}
			}
		}
		document.addEventListener('DOMContentLoaded', () => {
			const conversationId = window.location.pathname.split('/').slice(-2, -1)[0];
			const message_box = document.getElementById("message_box");
			const message_content = document.getElementById("message-content");
			const message_type = document.getElementById("message-type");
			const message_icon_parent = document.getElementById("message-icon-parent");
			const message_icon_child = document.getElementById("message-icon-child");

			const card = document.getElementById("card");

			const authenticated = localStorage.getItem("jerry_project_access_token");
			console.log(authenticated);
			if (authenticated) {
				console.log("called");
				let token = authenticated;
				const userApi = async () => {
					const userResponse = await fetch(`${window.location.origin}/api/user/`, {
						method: "GET",
						headers: {
							"content-type": "application/json",
							"Authorization": `Bearer ${token}`
						}
					});
					const userData = await userResponse.json();
					if (userData.success) {
						let userID = userData.data.id;
						let userProfiePicture = userData.data.profile_picture
						let userUsername = userData.data.username;
						const conversationResponse = await fetch(`${window.location.origin}/api/conversations/${conversationId}/`, {
							method: "GET",
							headers: {
								"content-type": "application/json",
								"Authorization": `Bearer ${authenticated}`
							}
						});
						const conversationData = await conversationResponse.json();
						if (conversationData.success) {
							const otherUserID = userID === conversationData.data.user1 ? conversationData.data.user2 : conversationData.data.user1;
							const otherUserProfilePicture = userID === conversationData.data.user1 ? conversationData.data.user2_profile_picture : conversationData.data.user1_profile_picture;
							const otherUsername = userID === conversationData.data.user1 ? conversationData.data.user2_username : conversationData.data.user1_username;
							document.getElementById('other_user_image').src = `/media/${otherUserProfilePicture}`;
							document.getElementById('other_user_username').innerHTML = otherUsername;
							fetchMessagesAndConnectWebSocket(userID, conversationId, userProfiePicture, userUsername);
						} else {
							showError("You are not allowed to access this");
						}
					} else {
						showError("Oops ! something went wrong");
					}
				};
				userApi();
			} else {
				showError("You are not logged in");
			}

			const showError = (message) => {
				card.style.display = "flex";
				card.style.borderLeft = "10px solid #3db5dc";
				message_content.innerHTML = message;
				message_type.innerHTML = "Info";
				message_type.style.color = "#3db5dc";
				message_icon_parent.style.color = "#3db5dc";
				message_icon_child.classList = "fas fa-exclamation-circle";
				setTimeout(() => {
					window.location.href = "/index/";
				}, 2000);
			};

			const fetchMessagesAndConnectWebSocket = async (userID, conversationId, userProfiePicture, userUsername) => {
				const messagesResponse = await fetch(`${window.location.origin}/api/messages/conversation-messages/?conversation_id=${conversationId}`, {
					method: "GET",
					headers: {
						"content-type": "application/json",
						"Authorization": `Bearer ${authenticated}`,
					}
				});
				const messagesData = await messagesResponse.json();
				if (messagesData.success) {
					displayMessages(messagesData.data, userID);
					connectWebSocket(userID, conversationId, userProfiePicture, userUsername);
				}
			};

			const displayMessages = (messages, userID) => {
				let str = '';
				messages.forEach((data) => {
					let formattedTime = data.timestamp.match(/T(\d{2}:\d{2})/)[1];
					if (userID !== data.sender) {
						str += `<div class="chats">
										<div class="chat-avatar">
											<img src="/media/${data.sender1_profile_picture}" class="rounded-circle dreams_chat" alt="image">
										</div>
										<div class="chat-content">
											<div class="chat-profile-name">
												<h6>${data.sender1_username}<span>${formattedTime}</span><span class="check-star msg-star d-none"><i class="bx bxs-star"></i></span></h6>
											</div>
											<div class="message-content">
											   ${data.content}
											</div>
										</div>
									</div>`;
					} else {
						str += `<div class="chats chats-right">
										<div class="chat-content">
											<div class="chat-profile-name text-end">
												<h6>${data.sender1_username}<span>${formattedTime}</span><span class="check-star msg-star-one d-none"><i class="bx bxs-star"></i></span></h6>
											</div>
											<div class="message-content ">
											   ${data.content}
											</div>
										</div>
										<div class="chat-avatar">
											<img src="/media/${data.sender1_profile_picture}" class="rounded-circle dreams_chat" alt="image">
										</div>
									</div>`;
					}
				});
				document.getElementById('allChats').innerHTML = str;
				scrolling();
			};

			const connectWebSocket = (userID, conversationId, userProfiePicture, userUsername) => {
				const protocol = window.location.protocol === "https:" ? "wss" : "ws";
                const host = window.location.protocol === "https:" ? `${window.location.hostname}:8003` : "127.0.0.1:8001";

                const ws = new WebSocket(`${protocol}://${host}/ws/global_chat/${user_uuid}/`);

				ws.onopen = () => {
					console.log('WebSocket connection opened');
				};

				ws.onmessage = (response) => {
					let chat_message = JSON.parse(response.data);
					messageReceived(chat_message, userID);
				};

				ws.onclose = () => {
					console.log('WebSocket connection closed');
				};

				ws.onerror = (error) => {
					console.log('WebSocket error: ', error);
				};

				document.getElementById("chat_button").addEventListener('click', (e) => {
					e.preventDefault()
					sendMessage(ws, userID, conversationId, userProfiePicture, userUsername);
				});


				document.getElementById("chat_input").onfocus = function (e) {
					ws.send(JSON.stringify({
						'type': 'typingstart',
						'conversation': conversationId,
						'sender': userID,
						'content': "",
						'profile_picture': userProfiePicture,
						'username': userUsername
					}))
				}

				document.getElementById("chat_input").onblur = function (e) {
					ws.send(JSON.stringify({
						'type': 'typingend',
						'sender': userID,
						'conversation': conversationId,
						'content': "",
						'profile_picture': userProfiePicture,
						'username': userUsername
					}))
				}

			};

			const messageReceived = (message, userID) => {
				console.log(message)
				if (message.type == 'chat') {
					if (userID != message.sender) {
						let tempinfo = document.querySelector('.tmp-info')

						if (tempinfo) {
							tempinfo.remove()
						}
					}
					let formattedTime = new Date(message.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
					let str = '';

					if (message.sender === userID) {
						str = `<div class="chats chats-right">
										<div class="chat-content">
											<div class="chat-profile-name text-end">
												<h6>${message.username}<span>${formattedTime}</span><span class="check-star msg-star-one d-none"><i class="bx bxs-star"></i></span></h6>
											</div>
											<div class="message-content ">
											   ${message.content}
											</div>
										</div>
										<div class="chat-avatar">
											<img src="${message.profile_picture}" class="rounded-circle dreams_chat" alt="image">
										</div>
									</div>`;
					} else {
						str = `<div class="chats">
										<div class="chat-avatar">
											<img src="${message.profile_picture}" class="rounded-circle dreams_chat" alt="image">
										</div>
										<div class="chat-content">
											<div class="chat-profile-name">
												<h6>${message.username}<span>${formattedTime}</span><span class="check-star msg-star d-none"><i class="bx bxs-star"></i></span></h6>
											</div>
											<div class="message-content">
											   ${message.content}
											</div>
										</div>
									</div>`;
					}
					document.getElementById('allChats').innerHTML += str;
				}

				else if (message.type == 'typingstart') {
					if (userID != message.sender) {
						let tempinfo = document.querySelector('.tmp-info')

						if (tempinfo) {
							tempinfo.remove()
						}
						document.getElementById("allChats").innerHTML += `<div class="chats tmp-info">
															<div class="chat-avatar">
																<img src="${message.profile_picture}"
																	class="rounded-circle dreams_chat" alt="image">
															</div>
															<div class="chat-content">
																<div class="chat-bubble">
																	<div class="typing">
																	  <div class="dot"></div>
																	  <div class="dot"></div>
																	  <div class="dot"></div>
																	</div>
																	</div>
															</div>
														</div>`
					}
				}
				else if (message.type == 'typingend') {
					if (userID != message.sender) {
						let tempinfo = document.querySelector('.tmp-info')

						if (tempinfo) {
							tempinfo.remove()
						}
					}
				}
				scrolling();
			};

			const sendMessage = (ws, userID, conversationId, userProfiePicture, userUsername) => {
				card.style.display = "none";
				let content = document.getElementById("chat_input");
				if (content.value.trim() !== '') {
					ws.send(JSON.stringify({
						'type': 'chat',
						'sender': userID,
						'profile_picture': userProfiePicture,
						'conversation': conversationId,
						'username': userUsername,
						'content': content.value
					}));
					content.value = ' ';
					scrolling();

				} else {
					card.style.display = "flex";
					card.style.borderLeft = "10px solid #3db5dc";
					message_content.innerHTML = "Message should not be blank";
					message_type.innerHTML = "Info";
					message_type.style.color = "#3db5dc";
					message_icon_parent.style.color = "#3db5dc";
					message_icon_child.classList = "fas fa-exclamation-circle";
				}
			};

			document.getElementById("message_close").addEventListener('click', () => {
				const card = document.getElementById("card");
				if (card) {
					card.style.display = "none"; // Hide the card
				}
			});
			
			

		});







	</script>
	<script src="/static/js/jquery-3.7.1.min.js"></script>

	<!-- Bootstrap Core JS -->
	<script src="/static/js/bootstrap.bundle.min.js"></script>

	<!-- Sticky Sidebar JS -->
	<script src="/static/plugins/theia-sticky-sidebar/ResizeSensor.js"></script>
	<script src="/static/plugins/theia-sticky-sidebar/theia-sticky-sidebar.js"></script>

	<!-- Slimscroll JS -->
	<script src="/static/js/jquery.slimscroll.min.js"></script>

	<!-- Swiper JS -->
	<script src="/static/plugins/swiper/swiper.min.js"></script>

	<!-- Custom JS -->
	<script src="/static/js/script.js"></script>


</body>

</html>