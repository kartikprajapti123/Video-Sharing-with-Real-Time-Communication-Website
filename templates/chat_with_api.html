<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
    <title>Dreams LMS</title>

    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="/static/img/favicon.svg">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">

    <!-- Fontawesome CSS -->
    <link rel="stylesheet" href="/static/plugins/fontawesome/css/fontawesome.min.css">
    <link rel="stylesheet" href="/static/plugins/fontawesome/css/all.min.css">

    <!-- Feather CSS -->
    <link rel="stylesheet" href="/static/css/feather.css">

    <!-- Boxioons CSS -->
    <link rel="stylesheet" href="/static/plugins/boxicons/css/boxicons.min.css">

    <!-- Swiper CSS -->
    <link rel="stylesheet" href="/static/plugins/swiper/swiper.min.css">

    <!-- Main CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/message_box.css">
    <style>
        .chat-bubble {
            background-color: #e5e5ea;
            padding: 16px 28px;
            -webkit-border-radius: 20px;
            -webkit-border-bottom-left-radius: 2px;
            -moz-border-radius: 20px;
            -moz-border-radius-bottomleft: 2px;
            border-radius: 20px;
            border-bottom-left-radius: 2px;
            display: inline-block;
        }

        .typing {
            align-items: center;
            display: flex;
            height: 17px;
        }

        .typing .dot {
            animation: mercuryTypingAnimation 1.8s infinite ease-in-out;
            background-color: black;
            ;
            border-radius: 50%;
            height: 7px;
            margin-right: 4px;
            vertical-align: middle;
            width: 7px;
            display: inline-block;
        }

        .typing .dot:nth-child(1) {
            animation-delay: 200ms;
        }

        .typing .dot:nth-child(2) {
            animation-delay: 300ms;
        }

        .typing .dot:nth-child(3) {
            animation-delay: 400ms;
        }

        .typing .dot:last-child {
            margin-right: 0;
        }

        @keyframes mercuryTypingAnimation {
            0% {
                transform: translateY(0px);
                background-color: #636262;
            }

            28% {
                transform: translateY(-7px);
                background-color: #2d2c2b;
            }

            44% {
                transform: translateY(0px);
                background-color: #0f0e0e;
            }
        }
    </style>

</head>

<body class="chat-page main-chat-blk">

    <div class="wrapper-success" id="message-box" style="position: fixed;z-index:1000000;width:50%;">
        <div id="card" style="transition-duration: 2s;width:330px;">
            <div class="icon" id="message-icon-parent"><i class="fas fa-times-circle " id="message-icon-child"></i>
            </div>
            <div class="subject">
                <h3 id="message-type">Success</h3>
                <p id="message-content">Anyone with access can view your invited visitors</p>
            </div>
            <div class="icon-times" id="message_close"><i class="fas fa-times"></i></div>
        </div>
    </div>
    <!-- Main Wrapper -->
    <div class="main-wrapper chat-wrapper">

        <!-- Header -->

        <!-- /Header -->

        <!-- Breadcrumb -->

        <!-- /Breadcrumb -->

        <!-- Page Content -->
        <div class="page-content chat-page-wrapper" style="margin:0px;padding-top:20px;">
            <div class="container">
                <div class="row" style="display: flex;justify-content:center;align-items:center;">

                    <!-- sidebar -->

                    <!-- /Sidebar -->

                    <!-- Student Profile -->
                    <div class="col-xl-9 col-lg-9 theiaStickySidebar">


                        <div class="settings-widget card-details mb-0">
                            <div class="settings-menu p-0">
                                <div class="profile-heading" style="display: flex;
   
    align-items: center;
    
    justify-content: space-between;
    margin: 0px;
    padding: 0px;">
                                    <!-- <h3 style="margin-left: 10px;">Message</h3> -->
                                    <div class="container"
                                        style="flex-wrap: nowrap;display:flex;justify-content:center;align-items:center;">
                                        <div class="navbar-header">
                                            <a id="mobile_btn" href="javascript:void(0);">
                                                <span class="bar-icon">
                                                    <span></span>
                                                    <span></span>
                                                    <span></span>
                                                </span>
                                            </a>
                                            <a href="/index/" class="navbar-brand logo">
                                                <img src="/static/img/logo.svg" class="img-fluid" alt="Logo">
                                            </a>
                                        </div>
                                        <div class="main-menu-wrapper menu-authenticated">
                                            <div class="menu-header">
                                                <a href="/index/" class="menu-logo">
                                                    <img src="/static/img/logo.svg" class="img-fluid" alt="Logo">
                                                </a>
                                                <a id="menu_close" class="menu-close" href="javascript:void(0);">
                                                    <i class="fas fa-times"></i>
                                                </a>
                                            </div>
                                            <ul class="main-nav">
                                                <li class="has-submenu">
                                                    <!-- <a class="" href="#">Home <i class="fas fa-chevron-down"></i></a> -->
                                                    <a href="/index/">Home </a>

                                                    <!-- <ul class="submenu">
                                                            <li class="active"><a href="/index/">Home</a></li>
                                                            <li><a href="index-two.html">Home Two</a></li>
                                                            <li><a href="index-three.html">Home Three</a></li>
                                                            <li><a href="index-four.html">Home Four</a></li>
                                                        </ul> -->
                                                </li>
                                                <li class="has-submenu">
                                                    <!-- <a class="" href="#">Home <i class="fas fa-chevron-down"></i></a> -->
                                                    <a href="#">Today's Feed </a>

                                                    <!-- <ul class="submenu">
                                                            <li class="active"><a href="/index/">Home</a></li>
                                                            <li><a href="index-two.html">Home Two</a></li>
                                                            <li><a href="index-three.html">Home Three</a></li>
                                                            <li><a href="index-four.html">Home Four</a></li>
                                                        </ul> -->
                                                </li>
                                                <li class="has-submenu">
                                                    <a href="#">Dashboard <i class="fas fa-chevron-down"></i></a>

                                                    <!-- <a class="" href="#">Dashboard</a> -->
                                                    <ul class="submenu">
                                                        <li><a href="#">Fan Dashbored</a></li>
                                                        <li><a href="#">Creator Dashbored</a></li>
                                                    </ul>
                                                </li>
                                                <li class="has-submenu">
                                                    <a href="#">Creator's <i class="fas fa-chevron-down"></i></a>
                                                    <ul class="submenu">
                                                        <!-- <li class="has-submenu">
                                                                <a href="#">Instructor</a>
                                                                <ul class="submenu">
                                                                    <li><a href="#">List</a></li>
                                                                    <li><a href="#">Grid</a></li>
                                                                </ul>
                                                            </li> -->
                                                        <li><a href="#">Popular</a></li>
                                                        <li><a href="#">Men</a></li>
                                                        <li><a href="#">Women</a></li>
                                                        <li><a href="#">Common</a></li>


                                                    </ul>
                                                </li>

                                                <!-- <li class="has-submenu">
                                                        <a href="#">Instructor <i class="fas fa-chevron-down"></i></a>
                                                        <ul class="submenu">
                                                            <li class="has-submenu">
                                                                <a href="instructor-list.html">Instructor</a>
                                                                <ul class="submenu">
                                                                    <li><a href="instructor-list.html">List</a></li>
                                                                    <li><a href="instructor-grid.html">Grid</a></li>
                                                                </ul>
                                                            </li>
                                                            <li><a href="instructor-dashboard.html">Dashboard</a></li>
                                                            <li><a href="instructor-profile.html">My Profile</a></li>
                                                            <li><a href="instructor-course.html">My Course</a></li>
                                                            <li><a href="instructor-wishlist.html">Wishlist</a></li>
                                                            <li><a href="instructor-reviews.html">Reviews</a></li>
                                                            <li><a href="instructor-quiz.html">My Quiz Attempts</a></li>
                                                            <li><a href="instructor-orders.html">Orders</a></li>
                                                            <li><a href="instructor-qa.html">Question & Answer</a></li>
                                                            <li><a href="instructor-referral.html">Referrals</a></li>
                                                            <li><a href="instructor-chat.html">Messages</a></li>
                                                            <li><a href="instructor-tickets.html">Support Ticket</a></li>
                                                            <li><a href="instructor-notifications.html">Notifications</a></li>
                                                            <li><a href="instructor-settings.html">Settings</a></li>
                                                        </ul>
                                                    </li>	 -->




                                            </ul>
                                        </div>
                                    </div>
                                    <a href="/myprofile/">

                                        <div class="add-course btn-primary" id="Send_Message" style="    width: fit-content;
            margin: 13px;">Back</div>
                                    </a>
                                </div>
                                <div class="checkout-form">
                                    <!-- sidebar group -->
                                    <div class="content">
                                        <div class="sidebar-group left-sidebar chat_sidebar" style="width:35%;">

                                            <!-- Chats sidebar -->
                                            <div id="chats" class="left-sidebar-wrap sidebar active slimscroll">

                                                <div class="slimscroll">

                                                    <!-- Left Chat Title -->
                                                    <div
                                                        class="left-chat-title all-chats d-flex justify-content-between align-items-center">
                                                        <div class="select-group-chat"
                                                            style="width:100%;text-align:center;">
                                                            <div class="dropdown">
                                                                <a href="javascript:void(0);">
                                                                    Contact List
                                                                </a>

                                                            </div>
                                                        </div>
                                                        <div class="add-section">

                                                        </div>
                                                    </div>

                                                    <div class="sidebar-body chat-body" id="chatsidebar">



                                                        <!-- /Left Chat Title -->
                                                        <ul class="user-list" id="contact-list">


                                                        </ul>
                                                    </div>

                                                </div>

                                            </div>
                                            <!-- / Chats sidebar -->
                                        </div>
                                        <!-- /Sidebar group -->

                                        <!-- Chat -->
                                        <div class="chat chat-messages" id="middle" style="display: none; width:40%;">
                                            <div class="h-100">
                                                <div class="chat-header">
                                                    <div class="user-details mb-0">

                                                        <figure class="avatar mb-0">
                                                            <img src="/static/img/user/user12.jpg"
                                                                class="rounded-circle" alt="image"
                                                                id="other_user_image">
                                                        </figure>
                                                        <div class="mt-1">
                                                            <h5 id="other_user_username"></h5>

                                                        </div>
                                                    </div>
                                                    <div class="chat-options ">

                                                    </div>

                                                </div>
                                                <div class="chat-body chat-page-group slimscroll">
                                                    <div class="messages" id="allChats"
                                                        style="overflow-x:hidden !important;overflow-y:scroll !important; ">

                                                    </div>
                                                </div>
                                                <div class="chat-footer">
                                                    <form id="chat_form">
                                                        <div class="replay-forms" style="position: relative;">
                                                            <input id="chat_input" type="text"
                                                                class="form-control chat_form"
                                                                placeholder="Type your message here..."
                                                                >
                                                            <div id="file-info"
                                                                style="display: none; position: absolute;left: 5px; top: 50%; transform: translateY(-50%); background: white; padding: 5px; border: 1px solid #ddd; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                                                                <span id="file-name" style="margin-right: 10px;"></span>
                                                                <button type="button" id="remove-file"
                                                                    style="background: none; border: none; color: red; cursor: pointer;">&times;</button>
                                                            </div>
                                                        </div>
                                                        <div class="form-buttons">
                                                            <button class="btn send-btn" type="submit" id="chat_button">
                                                                <i class="bx bx-paper-plane"></i>
                                                            </button>
                                                        </div>
                                                        <div class="form-buttons">
                                                            <label for="file-upload" class="btn"
                                                                style="background: #ff4667; color: white; padding: 20px; margin-left: 6px; margin-top: 6px;">
                                                                <i class="bx bx-upload"></i>
                                                            </label>
                                                            <input type="file" id="file-upload"
                                                                style="display: none;" />
                                                        </div>
                                                    </form>
                                                </div>

                                            </div>

                                            <!-- /Chat -->
                                        </div>
                                        <div id="empty_messages"
                                            style="width: 60%;
    display: flex;justify-content: center;align-items: center;flex-direction: column;border: 0.5px solid gray;border-radius: 10px;">
                                            <i class="fas fa-comment-alt" style="color: #ff4667;font-size: 50px;"></i>
                                            <h4 style="text-align: center;
    width: 70%;
    margin: 10px;
    color: gray;">Please select a chat from the contact list</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Student Profile -->

                    </div>
                </div>
            </div>
            <!-- /Page Content -->

            <!-- Footer -->
            <!-- /Footer -->

        </div>
        <!-- /Main Wrapper -->

        <!-- jQuery -->
        <script src="/static/js/jquery-3.7.1.min.js"></script>

        <!-- Bootstrap Core JS -->
        <script src="/static/js/bootstrap.bundle.min.js"></script>

        <!-- Sticky Sidebar JS -->
        <script src="/static/plugins/theia-sticky-sidebar/ResizeSensor.js"></script>
        <script src="/static/plugins/theia-sticky-sidebar/theia-sticky-sidebar.js"></script>

        <!-- Slimscroll JS -->
        <script src="/static/js/jquery.slimscroll.min.js"></script>

        <!-- Swiper JS -->
        <script src="/static/plugins/swiper/swiper.min.js"></script>

        <!-- Custom JS -->
        <script src="/static/js/script.js"></script>
        <script>
            const urlParams = new URLSearchParams(window.location.search);

            // Extract the conversation ID
            const ParamsconversationId = urlParams.get('conversation_id');

            //  contactlist
            let selectedFile = null;
            let active_chat=null;
            const message_box = document.getElementById("message_box");
            const message_content = document.getElementById("message-content");
            const message_type = document.getElementById("message-type");
            const message_icon_parent = document.getElementById("message-icon-parent");
            const message_icon_child = document.getElementById("message-icon-child");

            const card = document.getElementById("card");
            let currentWebSocket = null;
            const authenticated = localStorage.getItem("jerry_project_access_token");
            console.log(authenticated);
            if (authenticated) {
                console.log("called");
                let token = authenticated;

                const userApi = async () => {
                    try {
                        const userResponse = await fetch(`${window.location.origin}/api/user/`, {
                            method: "get",
                            headers: {
                                "content-type": "application/json",
                                "Authorization": `Bearer ${token}`
                            }
                        });

                        const userData = await userResponse.json();

                        if (userData.success) {
                            global_websocket_connection(userData.data.uuid,userData.data.id)
                            console.log(userData.data)
                            const profileID = userData.data.id;

                            const conversationsResponse = await fetch(`${window.location.origin}/api/conversations/user-conversations/?user_id=${profileID}`, {
                                method: "get",
                                headers: {
                                    "content-type": "application/json",
                                    "Authorization": `Bearer ${token}`
                                }
                            });

                            const conversationsData = await conversationsResponse.json();
                            console.log(conversationsData)
                            let str = "";

                            if (conversationsData.data.length > 0) {
                                for (const data of conversationsData.data) {
                                    let unreadmessages = 0;

                                    const unreadMessagesResponse = await fetch(`${window.location.origin}/api/messages/unread-messages/?conversation_id=${data.id}`, {
                                        method: "get",
                                        headers: {
                                            "content-type": "application/json",
                                            "Authorization": `Bearer ${token}`
                                        }
                                    });

                                    const unreadMessagesData = await unreadMessagesResponse.json();

                                    if (unreadMessagesData.success) {
                                        unreadmessages = unreadMessagesData.data.length;
                                    }

                                    let contact_list_image = "";
                                    let contact_list_username = "";

                                    if (profileID == data.user1) {
                                        contact_list_image = data.user2_profile_picture;
                                        contact_list_username = data.user2_username;
                                    } else {
                                        contact_list_image = data.user1_profile_picture;
                                        contact_list_username = data.user1_username;
                                    }

                                    str += `<li class="user-list-item chat-user-list" data-id="${data.id}">
                            <a href="javascript:void(0);" class="chat-link" style="border-left: none;">
                                <div class="avatar">
                                    <img src="/media/${contact_list_image}" class="rounded-circle" alt="image">
                                </div>
                                <div class="users-list-body">
                                    <div>
                                        <h5>${contact_list_username}</h5>
                                    </div>
                                    <div class="last-chat-time">
                                        <div class="chat-pin" id="count_${data.id}">
                                            ${unreadmessages > 0 ? `<span class="count-message" >${unreadmessages}</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </li>`;
                                }

                                document.getElementById("contact-list").innerHTML = str;

                                document.getElementById("contact-list").addEventListener("click", () => {
                                    const itemId = event.target.closest(".user-list-item").getAttribute("data-id");
                                    active_chat=itemId
                                    document.querySelectorAll(".chat-link").forEach(link => {
                                        link.style.borderLeft = "none";
                                    });
                                
                                    // Add the border-left style to the selected link
                                    const selectedLink = document.querySelector(`.user-list-item[data-id="${itemId}"] .chat-link`);
                                    if (selectedLink) {
                                        selectedLink.style.borderLeft = "10px solid #ff4667";
                                    }
                                
                                    // Handle chat selection
                                    active_chat = itemId;
                                    messages_list(itemId)
                                    Read_all_chat_notification(itemId,profileID)
                                })
                                if (ParamsconversationId) {
                                    document.querySelectorAll(".chat-link").forEach(link => {
                                        link.style.borderLeft = "none";
                                    });
                                
                                    // Add the border-left style to the selected link
                                    const selectedLink = document.querySelector(`.user-list-item[data-id="${ParamsconversationId}"] .chat-link`);
                                    if (selectedLink) {
                                        selectedLink.style.borderLeft = "10px solid #ff4667";
                                    }
                                
                                    // Handle chat selection
                                    active_chat = itemId;
                                    messages_list(ParamsconversationId)
                                    active_chat=ParamsconversationId
                                    Read_all_chat_notification(itemId,profileID)

                                }



                            } else {
                                document.getElementById("contact-list").innerHTML = `<div id="empty-contact-list" style="width: 100%;height:100%;display:flex;justify-content:center;align-items:center;flex-direction:column">
                         <i class="fas fa-user" style="color: #ff4667;font-size: 50px;"></i>
                                            <h4 style="text-align: center;
    width: 70%;
    margin: 10px;
    color: gray;">Your contact list is empty</h4>
                    </div>`;
                            }
                        } else {
                            console.log(userData);
                        }
                    } catch (error) {
                        console.error("An error occurred:", error);
                    }
                };

                userApi();
            } else {
                card.style.display = "flex";
                card.style.borderLeft = "10px solid #3db5dc";

                message_content.innerHTML = "You are not logged in";
                message_type.innerHTML = "Info";
                message_type.style.color = "#3db5dc";
                message_icon_parent.style.color = "#3db5dc";
                message_icon_child.classList = "fas fa-exclamation-circle";

                setTimeout(() => {
                    window.location.href = "/index/"
                }, 1000)
            }

            document.getElementById("message_close").addEventListener('click', () => {
                if (card) {
                    card.style.display = "none"; // Hide the card
                    // Or, if you want to completely remove the card from the DOM:
                    // card.remove();
                }
            });



            ////////////////////////////////messaes //////////////////////////////////////////
            
function scrolling() {
    const chatBody = document.querySelector('.chat-body');
    chatBody.scrollIntoView({ behavior: 'smooth', block: 'end' });
    chatBody.scrollTop = chatBody.scrollHeight;
}
    
    // Call this function after you add new messages


            const messages = (conversationId) => {
                document.getElementById("middle").style.display = "block"
                //const conversationId = window.location.pathname.split('/').slice(-2, -1)[0];
                const message_box = document.getElementById("message_box");
                const message_content = document.getElementById("message-content");
                const message_type = document.getElementById("message-type");
                const message_icon_parent = document.getElementById("message-icon-parent");
                const message_icon_child = document.getElementById("message-icon-child");

                const card = document.getElementById("card");

                const authenticated = localStorage.getItem("jerry_project_access_token");
                console.log(authenticated);
                if (authenticated) {
                    console.log("called");
                    let token = authenticated;
                    const userApi = async () => {
                        const userResponse = await fetch(`${window.location.origin}/api/user/`, {
                            method: "GET",
                            headers: {
                                "content-type": "application/json",
                                "Authorization": `Bearer ${token}`
                            }
                        });
                        const userData = await userResponse.json();
                        if (userData.success) {
                            let userID = userData.data.id;
                            let userProfiePicture = userData.data.profile_picture
                            let userUsername = userData.data.username;
                            const conversationResponse = await fetch(`${window.location.origin}/api/conversations/${conversationId}/`, {
                                method: "GET",
                                headers: {
                                    "content-type": "application/json",
                                    "Authorization": `Bearer ${authenticated}`
                                }
                            });
                            const conversationData = await conversationResponse.json();
                            if (conversationData.success) {
                                const otherUserID = userID === conversationData.data.user1 ? conversationData.data.user2 : conversationData.data.user1;
                                const otherUserProfilePicture = userID === conversationData.data.user1 ? conversationData.data.user2_profile_picture : conversationData.data.user1_profile_picture;
                                const otherUsername = userID === conversationData.data.user1 ? conversationData.data.user2_username : conversationData.data.user1_username;
                                document.getElementById('other_user_image').src = `/media/${otherUserProfilePicture}`;
                                document.getElementById('other_user_username').innerHTML = otherUsername;
                                fetchMessagesAndConnectWebSocket(userID, conversationId, userProfiePicture, userUsername);
                            } else {
                                showError("You are not allowed to access this");
                            }
                        } else {
                            showError("Oops ! something went wrong");
                        }
                    };
                    userApi();
                } else {
                    showError("You are not logged in");
                }

                const showError = (message) => {
                    card.style.display = "flex";
                    card.style.borderLeft = "10px solid #3db5dc";
                    message_content.innerHTML = message;
                    message_type.innerHTML = "Info";
                    message_type.style.color = "#3db5dc";
                    message_icon_parent.style.color = "#3db5dc";
                    message_icon_child.classList = "fas fa-exclamation-circle";
                    setTimeout(() => {
                        window.location.href = "/index/";
                    }, 2000);
                };

                const fetchMessagesAndConnectWebSocket = async (userID, conversationId, userProfiePicture, userUsername) => {
                    const messagesResponse = await fetch(`${window.location.origin}/api/messages/conversation-messages/?conversation_id=${conversationId}`, {
                        method: "GET",
                        headers: {
                            "content-type": "application/json",
                            "Authorization": `Bearer ${authenticated}`,
                        }
                    });
                    const messagesData = await messagesResponse.json();
                    if (messagesData.success) {
                        displayMessages(messagesData.data, userID);
                        connectWebSocket(userID, conversationId, userProfiePicture, userUsername);
                    }
                };

                const displayMessages = (messages, userID) => {
                    let str = '';
                    if (messages.length > 0) {


                        messages.forEach((data) => {
                            let formattedTime = data.timestamp.match(/T(\d{2}:\d{2})/)[1];
                            if (userID !== data.sender) {
                                if (data.file_url != null || data.file_url == '') {
                                    str += `<div class="chats">
                                <div class="chat-avatar">
                                    <img src="/media/${data.sender1_profile_picture}" class="rounded-circle dreams_chat" alt="image">
                                </div>
                                <div class="chat-content">
                                    <div class="chat-profile-name">
                                        <h6>${data.sender1_username}<span>${formattedTime}</span><span class="check-star msg-star-three d-none" ><i class="bx bxs-star"></i></span></h6>
                                    </div>
                                    <div class="message-content award-link chat-award-link">
                                        <a href="javascript:void(0);">${data.file_url}</a>
                                        <img src="${data.file_url}" class="img-fluid" alt="img">										  </div>
                                    </div>
                                </div>`
                                }
                                else {

                                    str += `<div class="chats">
                                <div class="chat-avatar">
                                    <img src="/media/${data.sender1_profile_picture}" class="rounded-circle dreams_chat" alt="image">
                                </div>
                                <div class="chat-content">
                                    <div class="chat-profile-name">
                                        <h6>${data.sender1_username}<span>${formattedTime}</span><span class="check-star msg-star d-none"><i class="bx bxs-star"></i></span></h6>
                                    </div>
                                    <div class="message-content">
                                        ${data.content}
                                    </div>
                                </div>
                            </div>`;
                                }
                            }
                            else {

                                if (data.file_url != null || data.file_url == '') {
                                    str += `<div class="chats chats-right">
									  
									  <div class="chat-content">
										  <div class="chat-profile-name">
											  <h6>${data.sender1_username}<span>${formattedTime}</span><span class="check-star msg-star-three d-none" ><i class="bx bxs-star"></i></span></h6>
										  </div>
										  <div class="message-content award-link chat-award-link">
											  <a href="javascript:void(0);" style="color:white;" >${data.file_url}</a>
											  <img src="${data.file_url}" class="img-fluid" alt="img">										  </div>
									  </div>
                                      <div class="chat-avatar">
										  <img src="/media/${data.sender1_profile_picture}" class="rounded-circle dreams_chat" alt="image">
									  </div>
								  </div>`
                                }
                                else {



                                    str += `<div class="chats chats-right">
                                        <div class="chat-content">
                                            <div class="chat-profile-name text-end">
                                                <h6>${data.sender1_username}<span>${formattedTime}</span><span class="check-star msg-star-one d-none"><i class="bx bxs-star"></i></span></h6>
                                            </div>
                                            <div class="message-content ">
                                                ${data.content}
                                            </div>
                                        </div>
                                        <div class="chat-avatar">
                                            <img src="/media/${data.sender1_profile_picture}" class="rounded-circle dreams_chat" alt="image">
                                        </div>
                                    </div>`;
                                }
                            }
                        });
                    }
                    else {
                        str += `<div id="empty_messages_inside">
                                                        <div style="width: 100%;
    
                                                        display: flex;
                                                        justify-content: center;
                                                        align-items: center;
                                                        flex-direction: column;
                                                        ">
                                                            <i class="fas fa-comment-alt"
                                                                style="color: #ff4667;font-size: 50px;"></i>
                                                            <h4 style="text-align: center;
                                                        width: 70%;
                                                        margin: 10px;
                                                        color: gray;">No chat messages between you </h4>
                                                        </div>
                                                    </div>

                                                </div>
`
                    }
                    document.getElementById('allChats').innerHTML = str;
                        scrolling();

                };

                const connectWebSocket = (userID, conversationId, userProfiePicture, userUsername) => {
                    const protocol = window.location.protocol === "https:" ? "wss" : "ws";
                    const host = window.location.protocol === "https:" ? `${window.location.hostname}:8003` : "127.0.0.1:8001";
                    if (currentWebSocket) {
                        currentWebSocket.close();
                        console.log("Previous WebSocket connection closed.");
                    }
                
                    const ws = new WebSocket(`${protocol}://${host}/ws/chat/${conversationId}/?token=${authenticated}`);

                    ws.onopen = () => {
                        console.log('WebSocket connection opened');
                    };

                    ws.onmessage = (response) => {
                        let chat_message = JSON.parse(response.data);
                        messageReceived(chat_message, userID);
                    };

                    ws.onclose = () => {
                        console.log('WebSocket connection closed');
                    };

                    ws.onerror = (error) => {
                        console.log('WebSocket error: ', error);
                    };
                    currentWebSocket = ws;

                    document.getElementById("chat_button").addEventListener('click', (e) => {
                        e.preventDefault()
                        
                            if (ws.readyState === WebSocket.OPEN) {
                                sendMessage(ws, userID, conversationId, userProfiePicture, userUsername);
                            } else {
                                console.log('Cannot send message, WebSocket is not open');
                            }
                    });


                    document.getElementById("chat_input").onfocus = function (e) {
                        ws.send(JSON.stringify({
                            'type': 'typingstart',
                            'conversation': conversationId,
                            'sender': userID,
                            'content': "",
                            'profile_picture': userProfiePicture,
                            'username': userUsername
                        }))
                    }

                    document.getElementById("chat_input").onblur = function (e) {
                        ws.send(JSON.stringify({
                            'type': 'typingend',
                            'sender': userID,
                            'conversation': conversationId,
                            'content': "",
                            'profile_picture': userProfiePicture,
                            'username': userUsername
                        }))
                    }

                };

                const messageReceived = (message, userID) => {
                    console.log(message)
                    if (message.type == 'chat') {
                        if (userID != message.sender) {
                            let tempinfo = document.querySelector('.tmp-info')

                            if (tempinfo) {
                                tempinfo.remove()
                            }
                        }
                        let formattedTime = new Date(message.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                        let str = '';

                        if (message.sender === userID) {
                            console.log(message.file_url)

                            if (message.file_url != null) {
                                str = `<div class="chats chats-right">
									  
									  <div class="chat-content">
										  <div class="chat-profile-name">
											  <h6>${message.username}<span>${formattedTime}</span><span class="check-star msg-star-three d-none" ><i class="bx bxs-star"></i></span></h6>
										  </div>
										  <div class="message-content award-link chat-award-link">
											  <a href="javascript:void(0);"  style="color:white;">${message.file_url}</a>
											  <img src="${message.file_url}" class="img-fluid" alt="img">										  </div>
									  </div>
                                      <div class="chat-avatar">
										  <img src="${message.profile_picture}" class="rounded-circle dreams_chat" alt="image">
									  </div>
								  </div>`
                            }
                            else {

                                str = `<div class="chats chats-right">
                        <div class="chat-content">
                            <div class="chat-profile-name text-end">
                                        <h6>${message.username}<span>${formattedTime}</span><span class="check-star msg-star-one d-none"><i class="bx bxs-star"></i></span></h6>
                                    </div>
                                    <div class="message-content ">
                                       ${message.content}
                                    </div>
                                </div>
                                <div class="chat-avatar">
                                    <img src="${message.profile_picture}" class="rounded-circle dreams_chat" alt="image">
                                </div>
                            </div>`;
                            }
                        }

                        else {
                            console.log(message)
                            let message_data = { "message_id": message.message_id }
                            let notification_data = { "notification_id": message.notification_id }

                            const messagesResponse = async () => {
                                await fetch(`${window.location.origin}/api/messages/mark-message-read/`, {

                                    method: "POST",
                                    headers: {
                                        "content-type": "application/json",
                                        "Authorization": `Bearer ${authenticated}`,
                                    },
                                    body: JSON.stringify(message_data)
                                }).then((resposne) => {
                                    return resposne.json()
                                }).then((response) => {
                                    console.log(response)
                                })
                            }
                            const notificationResponse = async () => {
                                await fetch(`${window.location.origin}/api/notification/single-mark-as-read/`, {

                                    method: "POST",
                                    headers: {
                                        "content-type": "application/json",
                                        "Authorization": `Bearer ${authenticated}`,
                                    },
                                    body: JSON.stringify(notification_data)
                                }).then((resposne) => {
                                    return resposne.json()
                                }).then((response) => {
                                    console.log(response)
                                })
                            }
                            let check = messagesResponse()
                            let check2 = notificationResponse()




                            console.log(message.file_url)
                            if (message.file_url != null) {
                                str = `<div class="chats">
                                <div class="chat-avatar">
                                    <img src="${message.profile_picture}" class="rounded-circle dreams_chat" alt="image">
                                </div>
                                <div class="chat-content">
                                    <div class="chat-profile-name">
                                        <h6>${message.username}<span>${formattedTime}</span><span class="check-star msg-star-three d-none" ><i class="bx bxs-star"></i></span></h6>
                                    </div>
                                    <div class="message-content award-link chat-award-link">
                                        <a href="javascript:void(0);">${message.file_url}</a>
                                        <img src="${message.file_url}" class="img-fluid" alt="img">										  </div>
                                    </div>
                                </div>`
                            }
                            else {
                                str = `<div class="chats">
                                    <div class="chat-avatar">
                                        <img src="${message.profile_picture}" class="rounded-circle dreams_chat" alt="image">
                                    </div>
                                    <div class="chat-content">
                                        <div class="chat-profile-name">
                                            <h6>${message.username}<span>${formattedTime}</span><span class="check-star msg-star d-none"><i class="bx bxs-star"></i></span></h6>
                                        </div>
                                        <div class="message-content">
                                            ${message.content}
                                        </div>
                                    </div>
                                </div>`;
                            }
                        }
                        document.getElementById('allChats').innerHTML += str;
                    }

                    else if (message.type == 'typingstart') {
                        if (userID != message.sender) {
                            let tempinfo = document.querySelector('.tmp-info')

                            if (tempinfo) {
                                tempinfo.remove()
                            }
                            document.getElementById("allChats").innerHTML += `<div class="chats tmp-info">
                                                    <div class="chat-avatar">
                                                        <img src="${message.profile_picture}"
                                                            class="rounded-circle dreams_chat" alt="image">
                                                    </div>
                                                    <div class="chat-content">
                                                        <div class="chat-bubble">
                                                            <div class="typing">
                                                              <div class="dot"></div>
                                                              <div class="dot"></div>
                                                              <div class="dot"></div>
                                                            </div>
                                                            </div>
                                                    </div>
                                                </div>`
                        }
                    }
                    else if (message.type == 'typingend') {
                        if (userID != message.sender) {
                            let tempinfo = document.querySelector('.tmp-info')

                            if (tempinfo) {
                                tempinfo.remove()
                            }
                        }
                    }
                    scrolling();
                };

                const sendMessage = async (ws, userID, conversationId, userProfiePicture, userUsername) => {
                    card.style.display = "none";
                    let content = document.getElementById("chat_input");
                    let fileUrl = null;

                    if (selectedFile == null && content.value.trim() === "") {
                        card.style.display = "flex";
                        card.style.borderLeft = "10px solid #3db5dc";
                        message_content.innerHTML = "Message should not be blank";
                        message_type.innerHTML = "Info";
                        message_type.style.color = "#3db5dc";
                        message_icon_parent.style.color = "#3db5dc";
                        message_icon_child.classList = "fas fa-exclamation-circle";
                        selectedFile = null;
                    }

                    // Upload the file and get URL if a file is selected
                    if (selectedFile) {
                        let formData = new FormData();
                        formData.append('image', selectedFile);

                        try {
                            const response = await fetch(`${window.location.origin}/api/uploads/`, { // Replace with your upload endpoint
                                method: 'POST',
                                headers: {
                                    "Authorization": `Bearer ${authenticated}`,
                                },
                                body: formData
                            }).then(response => response.json());

                            if (response.success) {
                                console.log(response.data.image);
                                fileUrl = response.data.image; // Get the file URL
                            } else {
                                card.style.display = "flex";
                                card.style.borderLeft = "10px solid #3db5dc";
                                message_content.innerHTML = response.message;
                                message_type.innerHTML = "Info";
                                message_type.style.color = "#3db5dc";
                                message_icon_parent.style.color = "#3db5dc";
                                message_icon_child.classList = "fas fa-exclamation-circle";
                                return; // Stop execution if upload fails
                            }
                        } catch (error) {
                            console.error('Upload error:', error);
                            card.style.display = "flex";
                            card.style.borderLeft = "10px solid #3db5dc";
                            message_content.innerHTML = "An error occurred while uploading the file.";
                            message_type.innerHTML = "Info";
                            message_type.style.color = "#3db5dc";
                            message_icon_parent.style.color = "#3db5dc";
                            message_icon_child.classList = "fas fa-exclamation-circle";
                            return; // Stop execution if upload fails
                        }
                    }

                    // Check if content is not empty
                    if (selectedFile != null || content.value.trim() !== "") {
                        const messagePayload = {
                            'type': 'chat',
                            'sender': userID,
                            'profile_picture': userProfiePicture,
                            'conversation': conversationId,
                            'username': userUsername,
                            'content': content.value,
                        };

                        // Add file URL to payload if it exists
                        if (fileUrl) {
                            messagePayload.file_url = fileUrl;
                        }

                        // Send the message
                        ws.send(JSON.stringify(messagePayload));
                        content.value = '';
                        content.placeholder = 'Type your message here...';
                        let fileInfo = document.getElementById('file-info');
                        let fileNameSpan = document.getElementById('file-name');
                        let fileInput = document.getElementById('file-upload');

                        fileNameSpan.textContent = ""
                        fileInfo.style.display = 'none';
                        content.disabled = false; // Enable the input field
                        fileInput.value = '';

                        try {
                            const emptyChatUser = document.getElementById("empty_messages_inside");
                            if (emptyChatUser && emptyChatUser.style.display !== "none") {
                                emptyChatUser.style.display = "none";
                            }
                        } catch (e) {
                            console.log(e);
                        }

                        selectedFile = null;
                        scrolling();
                    } else {
                        card.style.display = "flex";
                        card.style.borderLeft = "10px solid #3db5dc";
                        message_content.innerHTML = "Message should not be blank";
                        message_type.innerHTML = "Info";
                        message_type.style.color = "#3db5dc";
                        message_icon_parent.style.color = "#3db5dc";
                        message_icon_child.classList = "fas fa-exclamation-circle";
                    }
                };

                document.getElementById("message_close").addEventListener('click', () => {
                    const card = document.getElementById("card");
                    if (card) {
                        card.style.display = "none"; // Hide the card
                    }
                });



            };




            document.getElementById('file-upload').addEventListener('change', function (event) {
                const files = event.target.files;
                if (files.length > 0) {
                    selectedFile = files[0]; // Store the first file
                    const fileName = selectedFile.name;
                    const fileInfo = document.getElementById('file-info');
                    const fileNameSpan = document.getElementById('file-name');
                    const chatInput = document.getElementById('chat_input');

                    chatInput.value = ""
                    chatInput.placeholder = ""
                    fileNameSpan.textContent = fileName;
                    fileInfo.style.display = 'flex';
                    chatInput.disabled = true; // Disable the input field
                }
            });

            document.getElementById('remove-file').addEventListener('click', function () {
                selectedFile = null; // Remove the selected file
                const fileInfo = document.getElementById('file-info');
                const chatInput = document.getElementById('chat_input');
                const fileNameSpan = document.getElementById('file-name');
                const fileInput = document.getElementById('file-upload');

                chatInput.value = '';
                chatInput.placeholder = "Type your message here..."
                fileNameSpan.textContent = ""
                fileInfo.style.display = 'none';
                chatInput.disabled = false; // Enable the input field
                fileInput.value = '';
            });


            async function messages_list(conversationId) {
                document.getElementById("empty_messages").style.display = "none"

                const itemId = conversationId
                document.getElementById(`count_${itemId}`).innerHTML = ""



                // Function to mark messages as read
                const markMessagesRead = async (conversationId) => {
                    try {
                        const response = await fetch(`${window.location.origin}/api/messages/mark-messages-read/`, {
                            method: "POST",
                            headers: {
                                "content-type": "application/json",
                                "Authorization": `Bearer ${authenticated}`
                            },
                            body: JSON.stringify({ conversation_id: conversationId })
                        });
                        const data = await response.json();
                        return data.success; // Assume the response contains a 'success' field indicating the status
                    } catch (error) {
                        console.error("Error marking messages as read:", error);
                        return false;
                    }
                };

                // Call the function and redirect if successful
                const success = await markMessagesRead(itemId);
                if (success) {
                    console.log("Messages marked as read for conversation ID:", itemId);
                    //window.location.href = `/chatting/${itemId}/`;
                    messages(itemId)
                } else {
                    console.log("Failed to mark messages as read for conversation ID:", itemId);
                }
            }

            async function Read_all_chat_notification(conversationId,userId){
                console.log()
                await fetch(`${window.location.origin}/api/notification/multiple-mark-as-read/`, {
                    method: "POST",
                    headers: {
                        "content-type": "application/json",
                        "Authorization": `Bearer ${authenticated}`
                    },
                    body: JSON.stringify({ "common_uuid": conversationId,'user_id':userId })
                }).then((resposne)=>{
                    return resposne.json()
                }).then((response)=>{
                    console.log(response)
                })
            }
            

            function global_websocket_connection(user_uuid,userId){
                const protocol = window.location.protocol === "https:" ? "wss" : "ws";
                const host = window.location.protocol === "https:" ? `${window.location.hostname}:8003` : "127.0.0.1:8001";

                const ws = new WebSocket(`${protocol}://${host}/ws/global_chat/${user_uuid}/`);

                ws.onopen = () => {
                    console.log('global WebSocket connection opened');
                };

                ws.onmessage = async (response) => {
                    let global_message = JSON.parse(response.data);
                    console.log(global_message.conversation_id);
                    console.log(active_chat);
                
                    if (global_message.conversation_id !== active_chat) {
                        try {
                            // Fetch conversations
                            const conversationsResponse = await fetch(`${window.location.origin}/api/conversations/user-conversations/?user_id=${userId}`, {
                                method: "get",
                                headers: {
                                    "content-type": "application/json",
                                    "Authorization": `Bearer ${authenticated}`
                                }
                            });
                            const conversationsData = await conversationsResponse.json();
                            console.log(conversationsData);
                
                            let str = "";
                
                            if (conversationsData.data.length > 0) {
                                for (const data of conversationsData.data) {
                                    let unreadmessages = 0;
                
                                    // Fetch unread messages
                                    const unreadMessagesResponse = await fetch(`${window.location.origin}/api/messages/unread-messages/?conversation_id=${data.id}`, {
                                        method: "get",
                                        headers: {
                                            "content-type": "application/json",
                                            "Authorization": `Bearer ${authenticated}`
                                        }
                                    });
                                    const unreadMessagesData = await unreadMessagesResponse.json();
                
                                    if (unreadMessagesData.success) {
                                        unreadmessages = unreadMessagesData.data.length;
                                    }
                
                                    let contact_list_image = "";
                                    let contact_list_username = "";
                
                                    if (userId === data.user1) {
                                        contact_list_image = data.user2_profile_picture;
                                        contact_list_username = data.user2_username;
                                    } else {
                                        contact_list_image = data.user1_profile_picture;
                                        contact_list_username = data.user1_username;
                                    }
                
                                    str += `
                                        <li class="user-list-item chat-user-list" data-id="${data.id}">
                                            <a href="javascript:void(0);">
                                                <div class="avatar">
                                                    <img src="/media/${contact_list_image}" class="rounded-circle" alt="image">
                                                </div>
                                                <div class="users-list-body">
                                                    <div>
                                                        <h5>${contact_list_username}</h5>
                                                    </div>
                                                    <div class="last-chat-time">
                                                        <div class="chat-pin" id="count_${data.id}">
                                                            ${unreadmessages > 0 ? `<span class="count-message">${unreadmessages}</span>` : ''}
                                                        </div>
                                                    </div>
                                                </div>
                                            </a>
                                        </li>
                                    `;
                                }
                
                                document.getElementById("contact-list").innerHTML = str;
                
                                document.getElementById("contact-list").addEventListener("click", (event) => {
                                    const itemId = event.target.closest(".user-list-item").getAttribute("data-id");
                                    active_chat = itemId;
                                    messages_list(itemId);
                                    Read_all_chat_notification(itemId, userId);
                                });
                
                                if (ParamsconversationId) {
                                    messages_list(ParamsconversationId);
                                    active_chat = ParamsconversationId;
                                    Read_all_chat_notification(ParamsconversationId, userId);
                                }
                
                            } else {
                                document.getElementById("contact-list").innerHTML = `
                                    <div id="empty-contact-list" style="width: 100%;height:100%;display:flex;justify-content:center;align-items:center;flex-direction:column">
                                        <i class="fas fa-user" style="color: #ff4667;font-size: 50px;"></i>
                                        <h4 style="text-align: center; width: 70%; margin: 10px; color: gray;">
                                            Your contact list is empty
                                        </h4>
                                    </div>
                                `;
                            }
                        } catch (error) {
                            console.error("Error fetching conversations or unread messages:", error);
                        }
                    }
                };
                
                ws.onclose = () => {
                    console.log('WebSocket connection closed');
                };
                
                ws.onerror = (error) => {
                    console.log('WebSocket error: ', error);
                };
            }

        </script>

</body>

</html>