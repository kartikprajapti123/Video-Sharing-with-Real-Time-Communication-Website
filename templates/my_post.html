{% extends "base.html" %}
{% block title %}

{% endblock title %}
{% block style %}

{% endblock style %}
{% block body %}

<!-- Breadcrumb -->
<div class="breadcrumb-bar breadcrumb-bar-info" style="margin-top:100px;">
	<div class="container">
		<div class="row">
			<div class="col-md-12 col-12">
				<div class="breadcrumb-list">
					<h2 class="breadcrumb-title">My Posts</h2>
					<nav aria-label="breadcrumb" class="page-breadcrumb">
						<ol class="breadcrumb">
							<li class="breadcrumb-item"><a href="/index/">Home</a></li>
							<li class="breadcrumb-item active" aria-current="page">My posts</li>
						</ol>
					</nav>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- /Breadcrumb -->

<!-- Page Content -->
<div class="page-content">
	<div class="container">
		<div class="row">

			<!-- sidebar -->
			<div class="col-xl-3 col-lg-3 theiaStickySidebar">
				<div class="settings-widget dash-profile">
					<div class="settings-menu">
						<div class="profile-bg">
							<div class="profile-img">
								<a href="/myprofile/"><img id="profile_page_image"
										src="/media/profile_pictures/default_profile_image.png" alt="Img"></a>
							</div>
						</div>
						<div class="profile-group">
							<div class="profile-name text-center">
								<h4 id="profile_page_username2"> Username</h4>
								<a href="/upload-post/" class="add-course btn-primary">Upload New Post</a>
							</div>
						</div>
					</div>
				</div>
				<div class="settings-widget account-settings">
					<div class="settings-menu">
						<h3>Dashboard</h3>
						<ul>
							<li class="nav-item">
								<a href="/creator/" class="nav-link">
									<i class="bx bxs-tachometer"></i>Dashboard
								</a>
							</li>
							<li class="nav-item ">
								<a href="/myprofile/" class="nav-link">
									<i class="bx bxs-user"></i>My Profile
								</a>
							</li>
							<li class="nav-item active">
								<a href="/mypost/" class="nav-link">
									<i class="bx bxs-tachometer"></i>My Posts
								</a>
							</li>
							<!-- <li class="nav-item">
								<a href="instructor-enrolled-course.html" class="nav-link">
									<i class="bx bxs-graduation"></i>Enrolled Courses
								</a>
							</li>
							<li class="nav-item">
								<a href="instructor-wishlist.html" class="nav-link">
									<i class="bx bxs-heart"></i>Wishlist
								</a>
							</li>
							<li class="nav-item">
								<a href="instructor-reviews.html" class="nav-link">
									<i class="bx bxs-star"></i>Reviews
								</a>
							</li>
							<li class="nav-item">
								<a href="instructor-quiz.html" class="nav-link">
									<i class="bx bxs-shapes"></i>My Quiz Attempts
								</a>
							</li>
							<li class="nav-item">
								<a href="instructor-orders.html" class="nav-link">
									<i class="bx bxs-cart"></i>Order History
								</a>
							</li>
							<li class="nav-item">
								<a href="instructor-qa.html" class="nav-link">
									<i class="bx bxs-bookmark-alt"></i>Question & Answer
								</a>
							</li>
							<li class="nav-item">
								<a href="instructor-referral.html" class="nav-link">
									<i class="bx bxs-user-plus"></i>Referrals
								</a>
							</li> -->
							<li class="nav-item">
								<a href="/contact-list/" class="nav-link">
									<i class="bx bxs-chat"></i>Messages
								</a>
							</li>
							<!-- <li class="nav-item">
								<a href="instructor-notifications.html" class="nav-link">
									<i class="bx bxs-bell"></i>Notifications
								</a>
							</li>
							<li class="nav-item">
								<a href="instructor-tickets.html" class="nav-link">
									<i class="bx bxs-coupon"></i>Support Tickets
								</a>
							</li> -->
						</ul>
						<!-- <h3>Instructor</h3>
						<ul>
							<li class="nav-item">
								<a href="instructor-course.html" class="nav-link ">
									<i class="bx bxs-rocket"></i>My Courses
								</a>
							</li>
							<li class="nav-item">
								<a href="instructor-announcements.html" class="nav-link">
									<i class="bx bxs-volume-full"></i>Announcements
								</a>
							</li>
							<li class="nav-item">
								<a href="instructor-withdraw.html" class="nav-link ">
									<i class="bx bxs-wallet"></i>Withdrawls
								</a>
							</li>
							<li class="nav-item">
								<a href="instructor-quiz-attempts.html" class="nav-link">
									<i class="bx bxs-shapes"></i>Quiz Attempts
								</a>
							</li>
							<li class="nav-item">
								<a href="instructor-assignment.html" class="nav-link ">
									<i class="bx bxs-file"></i>Assignments
								</a>
							</li>
							<li class="nav-item">
								<a href="instructor-earnings.html" class="nav-link">
									<i class="bx bxs-badge-dollar"></i>Earnings
								</a>
							</li>
						</ul> -->
						<h3>Account Settings</h3>
						<ul>
							<li class="nav-item">
								<a href="/myprofileedit/" class="nav-link ">
									<i class="bx bxs-cog"></i>Settings
								</a>
							</li>
							<li class="nav-item">
								<div class="nav-link" onClick="LogoutApi()"><a href="#">

										<i class="bx bxs-log-out"></i>Logout
									</a>
								</div>
							</li>
						</ul>
					</div>
				</div>
			</div>
			<!-- /Sidebar -->

			<!-- Instructor Courses -->
			<div class="col-xl-9 col-lg-9">

				<div class="settings-widget card-info">
					<div class="settings-menu p-0">
						<div class="profile-heading">
							<h3>My Posts</h3>
							<p>Manage your posts and its updates</p>
						</div>
						<div class="checkout-form pb-0">
							<div class="wishlist-tab">
								<ul class="nav">
									<li class="nav-item">
										<a href="javascript:void(0);" class="active" data-bs-toggle="tab"
											data-bs-target="#enroll-courses">Approved (<span
												id="approved_count"></span>)</a>
									</li>
									<li class="nav-item">
										<a href="javascript:void(0);" data-bs-toggle="tab"
											data-bs-target="#active-courses">Pending (<span
												id="pending_count"></span>)</a>
									</li>
									<li class="nav-item">
										<a href="javascript:void(0);" data-bs-toggle="tab"
											data-bs-target="#complete-courses">Canceled (<span
												id="canceled_count"></span>)</a>
									</li>
								</ul>
							</div>

							<div class="tab-content">
								<div class="tab-pane fade show active" id="enroll-courses">
									<div class="row" id="approved">

										<!-- Course Grid -->

										<!-- /Course Grid -->

										<!-- Course Grid -->

										<!-- /Course Grid -->

									</div>
								</div>

								<div class="tab-pane fade" id="active-courses">
									<div class="row" id="pending">

										<!-- Course Grid -->
										<!-- /Course Grid -->

									</div>
								</div>

								<div class="tab-pane fade" id="complete-courses">
									<div class="row" id="canceled">

										<!-- Course Grid -->
										<!-- /Course Grid -->

									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- <div class="dash-pagination">
					<div class="row align-items-center">
						<div class="col-6">
							<p class="pagination_list">Page 1 of 2</p>
						</div>
						<div class="col-6">
							<ul class="pagination">
								<li class="active">
									<a href="#">1</a>
								</li>
								<li>
									<a href="#">2</a>
								</li>
								<li>
									<a href="#"><i class="bx bx-chevron-right"></i></a>
								</li>
							</ul>
						</div>
					</div>
				</div> -->

			</div>
			<!-- /Instructor Courses -->

		</div>
	</div>
</div>
<!-- /Page Content -->

<!-- Footer -->

{% endblock body %}
{% block script %}
<script>
	const profile_authenticated = localStorage.getItem("jerry_project_access_token");
	//const fetchPage = (page) => {
	//	const username = localStorage.getItem("username"); // Retrieve the username from localStorage
	//	if (username) {
	//		getUserPosts(profile_authenticated, username, page);
	//	} else {
	//		console.error("Username is not available in localStorage.");
	//	}
	//};
	const getUserPosts = async (token, username) => {
		await fetch(`${window.location.origin}/api/upload-post/?user_username=${username}&no_pagination=true`, {
			method: "GET",
			headers: {
				"content-type": "application/json",
				"Authorization": `Bearer ${token}`
			}
		}).then(response => response.json())
			.then(response => {
				console.log(response);
				if (response.data) {
					console.log("User posts fetched successfully:", response);
					// Display posts
					displayPosts(response.data);
				} else {
					console.log("Failed to fetch user posts.");
				}
			}).catch(error => {
				console.error("Error fetching user posts:", error);
			});
	};
	const displayPosts = (data) => {
		console.log(data);
		//document.getElementsByClassName("pagination_list")[0].innerHTML = `Page ${currentPage} of ${Math.ceil(totalCount / 10)}`

		let pending = "";
		let approved = "";
		let canceled = "";
		let pendingcount = 0;
		let approvedcount = 0;
		let canceledcount = 0;

		data.forEach(data => {
			const timestamp = new Date(data.created_at);

			// Format the date and time
			const formattedDate = timestamp.toLocaleDateString('en-US', {
				month: '2-digit',
				day: '2-digit',
				year: 'numeric'
			});
			const formattedTime = timestamp.toLocaleTimeString('en-US', {
				hour: '2-digit',
				minute: '2-digit',
				hour12: true
			});

			// Truncate the title if it's longer than 60 characters
			const truncatedTitle = data.title.length > 60 ? `${data.title.substring(0, 60)}...` : data.title;

			// Determine the video source and hover behavior
			const videoSrc = data.preview || data.video; // Use preview if available, otherwise use video
			const hoverAttributes = videoSrc
				? 'onmouseover="this.play()" onmouseout="this.pause() muted"'
				: '';

			// Ensure video source URL is valid
			const videoElement = videoSrc
				? `<video style="width: 100%;
    height: 300px;
    object-fit: contain;
    object-position: center;" alt="Img" src="${videoSrc}" poster="${data.thumbnail}" ${hoverAttributes} muted></video>`
				: '<div class="video-error">No video available</div>'; // Show an error message if no video

			const postHTML = (status) => `
				<div class="col-xxl-4 col-md-6 d-flex">
					<div class="course-box flex-fill">
						<div class="product">
							<div class="product-img">
								<a href="/post-view/${data.id}/">
									${videoElement}
								</a>
								<div class="price">
									<h3>$${data.price}</h3>
								</div>
							</div>
							<div class="product-content">
								<h3 class="title instructor-text"><a href="/post-view/${data.id}/">${truncatedTitle}</a></h3>
								<div class="course-info d-flex align-items-center">
									<div class="course-view d-flex align-items-center">
										<img src="/static/img/icon/icon-02.svg" alt="Img">
										<p>${formattedDate} ${formattedTime}</p>
									</div>
								</div>
								<div class="course-edit-btn d-flex align-items-center justify-content-between">
									<a href="/update-post/${data.id}"><i class="bx bx-edit me-2"></i>Edit</a>
									<a href="#" onclick="PostDelete(${data.id})"><i class="bx bx-trash me-2"></i>Delete</a>
								</div>
							</div>
						</div>
					</div>
				</div>`;

			if (data.status === "approved") {
				approved += postHTML("approved");
				approvedcount++;
			}
			if (data.status === "pending") {
				pending += postHTML("pending");
				pendingcount++;
			}
			if (data.status === "canceled") {
				canceled += postHTML("canceled");
				canceledcount++;
			}
		});

		// Update the DOM with the generated HTML and counts
		document.getElementById('approved').innerHTML = approved || `
			<div style="width: 100%; padding: 53px 10px; height: 100%; display: flex; justify-content: center; align-items: center; flex-direction: column">
				<i class="fas fa-exclamation-circle" style="color: #ff4667; font-size: 50px;"></i>
				<h4 style="text-align: center; width: 70%; margin: 10px; color: gray;">
					There are no approved posts.
				</h4>
			</div>`;
		document.getElementById('pending').innerHTML = pending || `
			<div style="width: 100%; padding: 53px 10px; height: 100%; display: flex; justify-content: center; align-items: center; flex-direction: column">
				<i class="fas fa-exclamation-circle" style="color: #ff4667; font-size: 50px;"></i>
				<h4 style="text-align: center; width: 70%; margin: 10px; color: gray;">
					There are no pending posts.
				</h4>
			</div>`;
		document.getElementById('canceled').innerHTML = canceled || `
			<div style="width: 100%; padding: 53px 10px;height: 100%; display: flex; justify-content: center; align-items: center; flex-direction: column">
				<i class="fas fa-exclamation-circle" style="color: #ff4667; font-size: 50px;"></i>
				<h4 style="text-align: center; width: 70%; margin: 10px; color: gray;">
					There are no canceled.
				</h4>
			</div>`;

		document.getElementById('approved_count').innerHTML = approvedcount;
		document.getElementById('pending_count').innerHTML = pendingcount;
		document.getElementById('canceled_count').innerHTML = canceledcount;

		// Pagination controls
		//const pagination = document.querySelector('.dash-pagination .pagination');
		//pagination.innerHTML = '';

		//const createPageLink = (page, text, isActive = false) => `
		//	<li ${isActive ? 'class="active"' : ''}>
		//		<a href="#" onclick="fetchPage(${page})" style="height: 40px;
		//width: 40px;
		//box-shadow: 0px 0px 5px gray;" >${text}</a>
		//	</li>
		//`;
		//
		//// Calculate total pages
		//const totalPages = Math.ceil(totalCount / perPage);
		//
		//if (previousPage) {
		//	pagination.innerHTML += createPageLink(currentPage - 1, '<i class="bx bx-chevron-left" style="font-size: 20px;color:black;"></i>');
		//}
		//for (let i = 1; i <= totalPages; i++) {
		//	pagination.innerHTML += createPageLink(i, i, i === currentPage);
		//}
		//if (nextPage) {
		//	pagination.innerHTML += createPageLink(currentPage + 1, '<i class="bx bx-chevron-right" style="font-size: 20px;color:black;"></i>');
		//}
	};



	if (profile_authenticated) {

		console.log("Token found, making API call...");
		let token = profile_authenticated;

		const userApi = async () => {
			await fetch(`${window.location.origin}/api/user/`, {
				method: "GET",
				headers: {
					"content-type": "application/json",
					"Authorization": `Bearer ${token}`
				}
			}).then(response => response.json())
				.then(response => {
					if (response.success) {
						console.log("User authenticated:", response);
						const username = response.data.username; // Retrieve the username
						localStorage.setItem("username", username);
						// Store username in localStorage
						// Call the API to get user posts
						getUserPosts(token, username);
					} else {
						console.log("User authentication failed.");
					}
				}).catch(error => {
					console.error("Error fetching user data:", error);
				});
		};



		userApi();


	} else {
		console.log("You are not logged in.");
	}
	async function PostDelete(id) {
		console.log("called")
		let check = confirm("Are you sure you want to delete post ")
		if (check) {

			card.style.display = "none";
			await fetch(`${window.location.origin}/api/upload-post/${id}/`, {
				method: "DELETE",
				headers: {
					"content-type": "application/json",
					"Authorization": `Bearer ${authenticated}`
				}

			}).then((response) => {
				return response.json()
			}).then((response) => {
				if (response.success) {
					card.style.display = "flex";
					card.style.borderLeft = "10px solid green";

					message_content.innerHTML = response.message;
					message_type.innerHTML = "Success";
					message_type.style.color = "green";
					message_icon_parent.style.color = "green";
					message_icon_child.classList = "fas fa-check-circle";

					userApi();
				}
				else {
					message_content.innerHTML = response.message;
					card.style.display = "flex";
					card.style.borderLeft = "10px solid red";
					message_type.innerHTML = "Error";
					message_type.style.color = "red";
					message_icon_parent.style.color = "red";
					message_icon_child.classList = "fas fa-times-circle";
				}
			})
		}
		else {
			return
		}
	}


</script>


{% endblock script %}