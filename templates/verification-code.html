<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
    <title>Verify-otp</title>
    
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="/static/img/favicon.svg">
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    
    <!-- Fontawesome CSS -->
    <link rel="stylesheet" href="/static/plugins/fontawesome/css/fontawesome.min.css">
    <link rel="stylesheet" href="/static/plugins/fontawesome/css/all.min.css">

    <!-- Owl Carousel CSS -->
    <link rel="stylesheet" href="/static/css/owl.carousel.min.css">
    <link rel="stylesheet" href="/static/css/owl.theme.default.min.css">
    
    <!-- Feathericon CSS -->
    <link rel="stylesheet" href="/static/plugins/feather/feather.css">

    <!-- Main CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/message_box.css">
</head>
<body>

    <!-- Main Wrapper -->
    <div class="main-wrapper">
    
        <div class="row">
        
            <!-- Login Banner -->
            <div class="col-md-6 login-bg">
                <div class="owl-carousel login-slide owl-theme">
                    <div class="welcome-login">
                        <div class="login-banner">
                            <img src="/static/img/login-img.png" class="img-fluid" alt="Logo">
                        </div>
                        <div class="mentor-course text-center">
                            <h2>Welcome to <br>DreamsLMS Courses.</h2>
                            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam.</p>
                        </div>
                    </div>
                    <div class="welcome-login">
                        <div class="login-banner">
                            <img src="/static/img/login-img.png" class="img-fluid" alt="Logo">
                        </div>
                        <div class="mentor-course text-center">
                            <h2>Welcome to <br>DreamsLMS Courses.</h2>
                            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam.</p>
                        </div>
                    </div>
                    <div class="welcome-login">
                        <div class="login-banner">
                            <img src="/static/img/login-img.png" class="img-fluid" alt="Logo">
                        </div>
                        <div class="mentor-course text-center">
                            <h2>Welcome to <br>DreamsLMS Courses.</h2>
                            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam.</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /Login Banner -->
            
            <div class="col-md-6 login-wrap-bg">        
            
                <!-- Login -->
                <div class="login-wrapper">
                    <div class="loginbox">
                        <div class="img-logo">
                            <img src="/static/img/logo.svg" class="img-fluid" alt="Logo">
                            <div class="back-home">
                                <a href="/signup/">Back to signup</a>
                            </div>
                        </div>
                        <h1>Enter Verification Code</h1>
                        <!-- Success message start  -->
                        <div class="wrapper-success" id="message-box">
                            <div id="card">
                                <div class="icon" id="message-icon-parent"><i class="fas fa-times-circle " id="message-icon-child"></i></div>
                                <div class="subject">
                                    <h3 id="message-type">Success</h3>
                                    <p id="message-content">Anyone with access can view your invited visitors</p>
                                </div>
                                <div class="icon-times" id="message_close"><i class="fas fa-times"></i></div>
                            </div>
                        </div>
                        <!-- Success message end  -->

                        <div class="reset-password">
                            <p>We have just sent a verification code to your registered email id</p>
                        </div>
                        <form id="verify_otp">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="d-flex digit-group" style="display: flex;justify-content:space-around;">
                                        <input type="text" class="form-control" id="digit-1" name="digit-1" data-next="digit-2" style="width:60px;border:2px solid pink" />
                                        <input type="text" class="form-control" id="digit-2" name="digit-2" data-next="digit-3" data-previous="digit-1" style="width:60px;border:2px solid pink" />
                                        <input type="text" class="form-control" id="digit-3" name="digit-3" data-next="digit-4" data-previous="digit-2" style="width:60px;border:2px solid pink" />
                                        <input type="text" class="form-control" id="digit-4" name="digit-4" data-next="digit-5" data-previous="digit-3" style="width:60px;border:2px solid pink" />
                                    </div>   
                                </div>
                                <div class="send-code">
                                    <a href="#" id="send_otp_again">Send the code again</a>
                                    <span id="timer" style="display: none; margin-left: 10px;"></span>
                                </div>
                                <div class="d-grid">
                                    <button class="btn btn-primary btn-start" type="submit">Submit</button role="submit">
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <!-- /Login -->
                
            </div>
            
        </div>
       
   </div>
   <!-- /Main Wrapper -->
  
    <!-- jQuery -->
    <script src="/static/js/jquery-3.7.1.min.js"></script>
    
    <!-- Bootstrap Core JS -->
    <script src="/static/js/bootstrap.bundle.min.js"></script>

    <!-- Owl Carousel -->
    <script src="/static/js/owl.carousel.min.js"></script>    
    
    <!-- Custom JS -->
    <script src="/static/js/script.js"></script>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        digit_1 = document.getElementById("digit-1")
        digit_2 = document.getElementById("digit-2")
        digit_3 = document.getElementById("digit-3")
        digit_4 = document.getElementById("digit-4")

            
        message_box = document.getElementById("message_box")
        message_content = document.getElementById("message-content")
        message_type = document.getElementById("message-type")
        message_icon_parent = document.getElementById("message-icon-parent")
        message_icon_child = document.getElementById("message-icon-child")
            
        card = document.getElementById("card")
            
            
        const url = window.location.href;
        const parts = url.split('/');
        const verify_token = parts[parts.length - 2];
            
            
        document.getElementById('verify_otp').addEventListener('submit', async function (e) {
            e.preventDefault();
            card.style.display = "none"
        
            let data = {
                otp:parseInt(digit_1.value + digit_2.value + digit_3.value + digit_4.value)
            };
        
            await fetch(`${window.location.origin}/api/verify-otp/${verify_token}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: JSON.stringify(data)
            }).then(response => response.json())
                .then(response => {
                
                    console.log(response);
                    if (response.success) {
                        scrollToTop();
                        card.style.display = "flex"
                        card.style.borderLeft = "10px solid green"
                    
                        message_content.innerHTML = response.message
                        message_type.innerHTML = "Success"
                        message_type.style.color = "green"
                        message_icon_parent.style.color = "green"
                        message_icon_child.classList = "fas fa-check-circle"
                        
                        localStorage.setItem("jerry_project_access_token", response.token.access_token);
					localStorage.setItem("jerry_project_refresh_token", response.token.refresh_token);


					setTimeout(() => {
						window.location.href = "/";
					}, 2000);
                    
						
                        // Handle success case
                    } else {
                        console.log(response.message)
                    
                        message_content.innerHTML = response.message
                        // Update message type and icon
                    
                        card.style.display = "flex "
                        card.style.borderLeft = "10px solid red"
                    
                        message_type.innerHTML = "Error";
                        message_type.style.color = "red";
                        message_icon_parent.style.color = "red";
                        message_icon_child.classList = "fas fa-times-circle";
                        scrollToTop();
                        // Handle error case
                    }
                }).catch(error => {
                    console.error('Error:', error);
                });
        });


		document.getElementById('send_otp_again').addEventListener('click', async function (e) {
            e.preventDefault();
            
            const sendOtpLink = document.getElementById('send_otp_again');
            const timerSpan = document.getElementById('timer');
            const timeoutDuration = 60; // in seconds
            
            // Hide the link to prevent multiple clicks
            sendOtpLink.style.pointerEvents = 'none';
            sendOtpLink.style.opacity = '0.5';
        
            await fetch(`${window.location.origin}/api/resend-otp/${verify_token}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                }
            }).then(response => response.json())
              .then(response => {
                  console.log(response);
                  if (response.success) {
                      card.style.display = "flex";
                      card.style.borderLeft = "10px solid green";
                      message_content.innerHTML = response.message;
                      message_type.innerHTML = "Success";
                      message_type.style.color = "green";
                      message_icon_parent.style.color = "green";
                      message_icon_child.classList = "fas fa-check-circle";
        
                      // Show the timer
                      let remainingTime = timeoutDuration;
                      timerSpan.style.display = 'inline';
                      timerSpan.textContent = `(${remainingTime}s)`;
                      
                      const countdown = setInterval(() => {
                          remainingTime -= 1;
                          timerSpan.textContent = `(${remainingTime}s)`;
                          if (remainingTime <= 0) {
                              clearInterval(countdown);
                              sendOtpLink.style.pointerEvents = 'auto';
                              sendOtpLink.style.opacity = '1';
                              timerSpan.style.display = 'none';
                          }
                      }, 1000);
                  } else {
                      console.log(response.message);
                      message_content.innerHTML = response.message;
                      card.style.display = "flex";
                      card.style.borderLeft = "10px solid red";
                      message_type.innerHTML = "Error";
                      message_type.style.color = "red";
                      message_icon_parent.style.color = "red";
                      message_icon_child.classList = "fas fa-times-circle";
                      scrollToTop();
        
                      // Re-enable the link immediately
                      sendOtpLink.style.pointerEvents = 'auto';
                      sendOtpLink.style.opacity = '1';
                  }
              }).catch(error => {
                  console.error('Error:', error);
        
                  // Re-enable the link immediately
                  sendOtpLink.style.pointerEvents = 'auto';
                  sendOtpLink.style.opacity = '1';
              });


        });

        document.getElementById("message_close").onclick = () => {
            card.style.display = "none"
        }

        function valueReset() {
            email.value = ""
            password.value = ""
        }

        function scrollToTop() {
            window.scrollTo(0, 0);
        }
    </script>
</body>
</html>
